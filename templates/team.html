{% extends 'base.html' %}
{% block content %}
<h2>Team Total Points</h2>
<form method="post">
  <label>CTFtime Team ID
    <input type="text" name="team_id" value="{{ team_id }}" placeholder="e.g., 123456" required />
  </label>
  <label>Top N events (Make sure to choose 10 to calculate your total points)
    <input type="number" name="top_n" value="{{ top_n or 10 }}" min="1" max="20" />
  </label>
  <div style="margin: .5rem 0;">
    <label>
      <input type="checkbox" id="include_hosted" name="include_hosted" {% if include_hosted %}checked{% endif %} onclick="toggleIncludeHosted()" />
      Include your hosted events (requires event number eg. https://ctftime.org/event/2848)
    </label>
  <input type="text" id="event_id" name="event_id" placeholder="enter event number (e.g., 2848)" value="{{ event_id or '' }}" {% if not include_hosted %}disabled{% endif %} onfocus="forceIncludeHosted()" onclick="forceIncludeHosted()" />
    {% if event_weight is not none %}
      <span title="Rating weight fetched from event page">Weight: {{ '%.2f'|format(event_weight) }} & Points Gain = {{ '%.2f'|format(event_weight * 2) }}</span>
    {% endif %}
  </div>
  <button type="submit">Fetch</button>
</form>

{% if events %}
  <h3>Results</h3>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Place</th>
        <th>Event</th>
        <th>Rating</th>
        <th>Hosted</th>
      </tr>
    </thead>
    <tbody>
      {% for e in top %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ e.place }}</td>
        <td>
          {% if e.event_link %}
            <a href="{{ e.event_link }}" target="_blank" rel="noreferrer">{{ e.event_name }}</a>
          {% else %}
            {{ e.event_name }}
          {% endif %}
        </td>
        <td>{{ '%.3f'|format(e.rating_points) }}</td>
        <td>{% if e.is_hosted %}*{% endif %}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if total is not none %}
    <p><strong>Total (top {{ top|length }}): {{ '%.3f'|format(total) }}</strong></p>
  {% endif %}
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  function toggleIncludeHosted() {
    const include = document.getElementById('include_hosted');
    const eventInput = document.getElementById('event_id');
    eventInput.disabled = !include.checked;
  }
  function forceIncludeHosted() {
    const include = document.getElementById('include_hosted');
    const eventInput = document.getElementById('event_id');
    if (!include.checked) {
      include.checked = true;
      eventInput.disabled = false;
    }
  }
  // Initialize on load in case of server-rendered state
  document.addEventListener('DOMContentLoaded', function () {
    // Bind change handler, then sync initial state
    const include = document.getElementById('include_hosted');
    if (include) {
      include.addEventListener('change', toggleIncludeHosted);
    }
    toggleIncludeHosted();
  });
</script>
{% endblock %}
